<div class="content" style="padding-bottom: 80px;">
    <!--MODULE CITY/info : cit_if" <br>-->

    <h1  class="city-title">
		BARCELONA
	</h1>

	<h3 class="country-title text-muted">
		CATALONIA / SPAIN
	</h3>

	<p class="city-description text-muted"> The Barcelona metropolitan area comprises over 66% of the people in one of the richest regions in Europe – Catalonia, with a GDP per capita amounting to €28,400 (16% more than the EU average). Barcelona has a long-standing mercantile tradition. Less well known is that the region was one of the earliest to begin industrialization in continental Europe, beginning with textile-related works from the mid-1780s but really gathering momentum in the mid-19th century, when it became a major centre for the production of textiles and machinery. Since then, manufacturing has played a large role in its history.
	</p>

    <h2>Resilience index</h2>

    <div id="container" class="svg-container">
    </div>
    <!-- added specific class "svg_oecd" -> style because it was affecting map/Leaflet rendering -->

    <script>
        // Colors for the resilience metrics
        var resilience_colors = {
            "Housing": "#16785D",
            "Income": "#22357C",
            "Jobs": "#1A5774",
            "Community": "#67A61E",
            "Environment": "#1A9022",
            "Education": "#551C7B",
            "Civic engagement": "#7A1676",
            "Work life balance": "#A81E3E",
            "Life satisfaction": "#E62339",
            "Safety": "#B78621",
            "Health": "#B74021",
            "Accessibility to services": "#B7B721"
        };

        // Load both regions and countries
        d3.queue()
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/national.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/regional.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/city_gdp.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/city_pop.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/city_surf.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/region_gdp.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/region_pop.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/region_surf.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/country_gdp.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/OECD/country_pop.csv")
            .defer(d3.csv, "../../../static/data_custom/json_stats/WB/country_surf.csv")
            .await(function(error, countries_wellbeing, regions_wellbeing, city_gdp, city_pop, city_surf, region_gdp, region_pop, region_surf, country_gdp, country_pop, country_surf) {
                if (error) {
                    console.error('An error loading data: ' + error);
                } else {

                    // Clean data
                    var region_array = [];
                    for (var property in regions_wellbeing[0]) {
                        if (property != "Region" && property != "Region Code" && property != "Country") {
                            //region_object[property] = parseFloat(region_data[property]);
                            test = {}
                            test[property] = parseFloat(regions_wellbeing[0][property]);
                            region_array.push(test);
                        }
                    }

                    var country_array = [];
                    for (var property in countries_wellbeing[0]) {
                        if (property != "Country") {
                            //region_object[property] = parseFloat(region_data[property]);
                            test = {}
                            test[property] = parseFloat(countries_wellbeing[0][property]);
                            country_array.push(test);
                        }
                    }

                    // Calculte the city resilience, in our way
                    var city_array = JSON.parse(JSON.stringify(region_array));
                    for (property in region_array) {
                        //city_array[property] = region_array[property];
                        for (subproperty in city_array[property]) {
                            city_array[property][subproperty] = city_array[property][subproperty] * 0.2;
                        }
                    }

                    // Debug: Barcelona
                    console.log(city_gdp[69]["City Name"], city_gdp[69]["City Code"], city_gdp[69]["2012"]);
                    console.log(city_pop[69]["City Name"], city_pop[69]["City Code"], city_pop[69]["2014"]);
                    console.log(city_surf[69]["City Name"], city_surf[69]["City Code"], city_surf[69]["2014"]);

                    console.log(region_gdp[848]["Region Name"], region_gdp[848]["Region Code"], region_gdp[848]["2012"]);
                    console.log(region_pop[848]["Region Name"], region_pop[848]["Region Code"], region_pop[848]["2014"]);
                    console.log(region_surf[848]["Region Name"], region_surf[848]["Region Code"], region_surf[848]["2014"]);

                    console.log(country_gdp[25]["Country Name"], country_gdp[25]["Country Code"], country_gdp[25]["2015"]);
                    console.log(country_pop[29]["Country Name"], country_pop[29]["Country Code"], country_pop[29]["2011"]);
                    console.log(country_surf[179]["Country Name"], country_surf[179]["Country Code"], country_surf[179]["2015"]);


                    // variables
                    var zerox = 10;
                    var zeroy = 10;
                    var width = 300;
                    var barHeight = 13;
                    var space_between_bars = barHeight * 2;
                    var space_between_groups = 20;
                    var legend_width = 200;

                    // Linear scale for scaling the graph
                    var linearScale = d3.scaleLinear()
                        .domain([0, 10.0])
                        .range([0, width]);

                    // Access svg area
                    var svg = d3.select("div#container")
                    .append("svg")
                    .attr("preserveAspectRatio", "xMinYMin meet")
                    .attr("viewBox", "0 0 300 300")
                    .classed("svg-content", true);

                    // Rounded bars
                    var regions = svg.append("g");
                    var countries = svg.append("g");
                    var cities = svg.append("g");

                    var barr = regions.selectAll("g")
                        .data(region_array)
                        .enter()
                        .append("g")

                    var barc = countries.selectAll("g")
                        .data(country_array)
                        .enter()
                        .append("g")

                    var barci = cities.selectAll("g")
                        .data(city_array)
                        .enter()
                        .append("g")

                    // Scale line: city
                    barci.append("line")
                        .style("stroke", "#b3b3b3")
                        .attr("x1", zerox + legend_width)
                        .attr("y1", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6;
                        })
                        .attr("x2", zerox + legend_width + linearScale(10))
                        .attr("y2", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6;
                        });

                    // Scale line: region
                    barr.append("line")
                        .style("stroke", "#b3b3b3")
                        .style("opacity", 0.4)
                        .attr("x1", function(d) {
                            for (property in d) {
                                var resilience_value = d[property];
                            }
                            return zerox + legend_width + linearScale(resilience_value);
                        })
                        .attr("y1", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6 + barHeight;
                        })
                        .attr("x2", zerox + legend_width + linearScale(10))
                        .attr("y2", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6 + barHeight;
                        });

                    // Scale line: country
                    barc.append("line")
                        .style("stroke", "#b3b3b3")
                        .style("opacity", 0.2)
                        .attr("x1", function(d) {
                            for (property in d) {
                                var resilience_value = d[property];
                            }
                            return zerox + legend_width + linearScale(resilience_value);
                        })
                        .attr("y1", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6 + barHeight * 2;
                        })
                        .attr("x2", zerox + legend_width + width)
                        .attr("y2", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6 + barHeight * 2;
                        });

                    // The bars: region
                    barr.append("rect")
                        .attr("class", function(d) {
                            for (property in d) {
                                var the_class = property;
                            }
                            return "region " + property.toLowerCase() + " bar";
                        })
                        .style("opacity", 0.4)
                        .attr("x", zerox + legend_width)
                        .attr("y", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + barHeight;
                        })
                        .attr("width", function(d) {
                            for (property in d) {
                                var resilience_value = d[property];
                            }
                            return linearScale(resilience_value);
                        })
                        .attr("height", barHeight)
                        .attr("rx", 6)
                        .attr("ry", 6)
                        .attr("fill", function(d) {
                            for (property in d) {
                                var the_color = resilience_colors[property];
                            }
                            return the_color;
                        });

                    // The legend labels: region
                    barr.append("text")
                        .style("opacity", 0.4)
                        .attr("x", zerox)
                        .attr("y", function(d, i) {
                            return zeroy + 6 + i * (space_between_bars + space_between_groups) + barHeight;
                        })
                        .attr("dy", ".35em")
                        .text("Values at regional level");

                    // The legend labels: cities
                    barci.append("text")
                        .attr("x", zerox)
                        .attr("y", function(d, i) {
                            return zeroy + 6 + i * (space_between_bars + space_between_groups);
                        })
                        .attr("dy", ".35em")
                        .text(function(d) {
                            for (property in d) {
                                var label_text = property;
                            }
                            return label_text;
                        });

                    // The legend labels: country
                    barc.append("text")
                        .style("opacity", 0.2)
                        .attr("x", zerox)
                        .attr("y", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6 + barHeight * 2;
                        })
                        .attr("dy", ".35em")
                        .text("Value at country level");

                    // The value labels: region
                    barr.append("text")
                        .attr("class", function(d) {
                            for (property in d) {
                                var the_class = property;
                            }
                            return "region " + property.toLowerCase() + " value";
                        })
                        .style("opacity", 0.4)
                        .text(function(d) {
                            for (property in d) {
                                var label_value = d[property];
                            }
                            return label_value + "/10";
                        })
                        .attr("x", zerox + legend_width + width + zerox)
                        .attr("y", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + barHeight * 2;
                        });

                    // The value labels: cities
                    barci.append("text")
                        .attr("class", function(d) {
                            for (property in d) {
                                var the_class = property;
                            }
                            return "city " + property.toLowerCase() + " value";
                        })
                        .text(function(d) {
                            for (property in d) {
                                var label_value = d[property];
                            }
                            return Math.round(label_value * 10) / 10 + "/10";
                        })
                        .attr("x", zerox + legend_width + width + zerox)
                        .attr("y", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + barHeight;
                        });

                    // The value labels: countries
                    barc.append("text")
                        .attr("class", function(d) {
                            for (property in d) {
                                var the_class = property;
                            }
                            return "countries " + property.toLowerCase() + " value";
                        })
                        .style("opacity", 0.2)
                        .text(function(d) {
                            for (property in d) {
                                var label_value = d[property];
                            }
                            return Math.round(label_value * 10) / 10 + "/10";
                        })
                        .attr("x", zerox + legend_width + width + zerox)
                        .attr("y", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + 6 + barHeight + 6 + barHeight;
                        });

                    // The bars: city
                    barci.append("rect")
                        .attr("class", function(d) {
                            for (property in d) {
                                var the_class = property;
                            }
                            return "city " + property.toLowerCase() + " bar";
                        })
                        .attr("x", zerox + legend_width)
                        .attr("y", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups);
                        })
                        .attr("width", function(d) {
                            for (property in d) {
                                var resilience_value = d[property];
                            }
                            return linearScale(resilience_value);
                        })
                        .attr("height", barHeight)
                        .attr("rx", 6)
                        .attr("ry", 6)
                        .attr("fill", function(d) {
                            for (property in d) {
                                var the_color = resilience_colors[property];
                            }
                            return the_color;
                        });

                    // The bars: country
                    barc.append("rect")
                        .style("opacity", 0.1)
                        .attr("class", function(d) {
                            for (property in d) {
                                var the_class = property;
                            }
                            return "country " + property.toLowerCase() + " bar";
                        })
                        .attr("x", zerox + legend_width)
                        .attr("y", function(d, i) {
                            return zeroy + i * (space_between_bars + space_between_groups) + space_between_bars / 2 + barHeight;
                        })
                        .attr("width", function(d) {
                            for (property in d) {
                                var resilience_value = d[property];
                            }
                            return linearScale(resilience_value);
                        })
                        .attr("height", barHeight)
                        .attr("rx", 6)
                        .attr("ry", 6)
                        .attr("fill", function(d) {
                            for (property in d) {
                                var the_color = resilience_colors[property];
                            }
                            return the_color;
                        });

                    // SVG icons
                    var accessibility_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/accesibility_to_services_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        accessibility_icon.node().appendChild(xml.documentElement);
                    });

                    var civic_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/civic_engagement_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        civic_icon.node().appendChild(xml.documentElement);
                    });

                    var community_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/community_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        community_icon.node().appendChild(xml.documentElement);
                    });

                    var education_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/education_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        education_icon.node().appendChild(xml.documentElement);
                    });

                    var environment_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/environment_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        environment_icon.node().appendChild(xml.documentElement);
                    });

                    var health_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/health_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        health_icon.node().appendChild(xml.documentElement);
                    });

                    var housing_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/housing_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        housing_icon.node().appendChild(xml.documentElement);
                    });

                    var income_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/housing_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        income_icon.node().appendChild(xml.documentElement);
                    });

                    var jobs_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/jobs_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        jobs_icon.node().appendChild(xml.documentElement);
                    });

                    var life_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/life_satisfaction_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        life_icon.node().appendChild(xml.documentElement);
                    });

                    var safety_icon = svg.append("g");
                    d3.xml("../../../static/images/icons/svg/safety_cr.svg").mimeType("image/svg+xml").get(function(error, xml) {
                        if (error) throw error;
                        safety_icon.node().appendChild(xml.documentElement);
                    });

                    // SVG icons transformations
                    var icon_scale = 0.02;
                    var icon_x = legend_width - 20;
                    var icon_y = 5 + barHeight;

                    education_icon.attr("transform", "translate (" + icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");
                    icon_y = icon_y + space_between_bars + space_between_groups;
                    jobs_icon.attr("transform", "translate (" + icon_x +
                        ", " + icon_y + ") scale(" +
                        icon_scale + ")");
                    icon_y = icon_y + space_between_bars + space_between_groups;
                    income_icon.attr("transform", "translate (" + icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");
                    icon_y = icon_y +
                        space_between_bars + space_between_groups;
                    safety_icon.attr(
                        "transform", "translate (" + icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");
                    icon_y = icon_y + space_between_bars + space_between_groups;
                    health_icon.attr("transform", "translate (" + icon_x + ", " + icon_y +
                        ") scale(" + icon_scale +
                        ")");
                    icon_y = icon_y + space_between_bars + space_between_groups;
                    environment_icon.attr("transform", "translate (" + icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");
                    icon_y = icon_y + space_between_bars +
                        space_between_groups;
                    civic_icon.attr("transform",
                        "translate (" + icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");
                    icon_y = icon_y + space_between_bars + space_between_groups;
                    accessibility_icon.attr("transform", "translate (" + icon_x + ", " + icon_y +
                        ") scale(" + icon_scale + ")");
                    icon_y = icon_y + space_between_bars + space_between_groups;
                    housing_icon.attr("transform", "translate (" + icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");
                    icon_y = icon_y +
                        space_between_bars + space_between_groups;
                    community_icon.attr("transform", "translate (" +
                        icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");
                    icon_y = icon_y + space_between_bars + space_between_groups;
                    life_icon.attr("transform", "translate (" + icon_x + ", " + icon_y + ") scale(" + icon_scale + ")");

                    // Slider
                    // From https://bl.ocks.org/mbostock/6452972

                    var x = d3.scaleLinear()
                        .domain([0, 100])
                        .range([0, width])
                        .clamp(true);

                    var slider = svg.append("g")
                        .attr("class", "slider")
                        .attr("transform", "translate(" + zerox + ", 600)");

                    slider.append("text")
                        .text("Slider: how many instances of the projects in the city?")
                        .attr("x", 0)
                        .attr("y", -20);

                    slider.append("line")
                        .attr("class", "track")
                        .attr("x1", x.range()[0])
                        .attr("x2", x.range()[1])
                        .select(function() {
                            return this.parentNode.appendChild(this.cloneNode(true));
                        })
                        .attr("class", "track-inset")
                        .select(function() {
                            return this.parentNode.appendChild(this.cloneNode(true));
                        })
                        .attr("class", "track-overlay")
                        .call(d3.drag()
                            .on("start.interrupt", function() {
                                slider.interrupt();
                            })
                            .on("start drag", function() {
                                hue(x.invert(d3.event.x));
                            }));

                    slider.insert("g", ".track-overlay")
                        .attr("class", "ticks")
                        .attr("transform", "translate(0," + 18 + ")")
                        .selectAll("text")
                        .data(x.ticks(10))
                        .enter().append("text")
                        .attr("x", x)
                        .attr("y", 10)
                        .attr("text-anchor", "middle")
                        .text(function(d) {
                            return d;
                        });

                    var handle = slider.insert("rect", ".track-overlay")
                        .attr("class", "handle")
                        .attr("width", 6)
                        .attr("height", 20)
                        .attr("y", -10)
                        .attr("rx", 3)
                        .attr("ry", 3);

                    function hue(h) {
                        handle.attr("x", x(h));
                        console.log(h);
                        d3.select(".city.education.bar").attr("width", linearScale(h / 10));
                        d3.select(".city.education.value").text(Math.round(h) / 10 + "/10");
                    }

                }
            });
    </script>


</div>






<div class="content" >   <!-- DYNAMIC REGIONS CALLING WITH JINJA + CORRESPONDING GEOJSON <br>-->

	<!-- LEAFLET + D3 : http://bl.ocks.org/d3noob/9267535 -->

	<!-- D3.JS V4-->
	<!--<script type="text/javascript" src="{{ url_for('static', filename='bower_components/d3/d3.js') }}"></script>-->
	<!---->
	
	
	<!-- LEAFLET LIBRARIES -->
	<script type="text/javascript" src="{{ url_for('static', filename='bower_components/leaflet/dist/leaflet-src.js') }}"></script>		
	<link   rel="stylesheet" href="{{ url_for('static', filename='bower_components/leaflet/dist/leaflet.css') }}" />
	
	<script type="text/javascript" src="{{ url_for('static', filename='bower_components/leaflet.markercluster/dist/leaflet.markercluster-src.js') }}"></script>
	<link   rel="stylesheet" href="{{ url_for('static', filename='bower_components/leaflet.markercluster/dist/MarkerCluster.css') }}" />
	<link   rel="stylesheet" href="{{ url_for('static', filename='bower_components/leaflet.markercluster/dist/MarkerCluster.Default.css') }}" />

	<!-- SETVIEWS DICT // GLOBAL SETTINGS DICT -->
	<script src="{{ url_for('static', filename='data_custom/setGeoViews.js') }}" type="text/javascript"></script>
	
	
	
	<!--region_specs == {{ region_specs }} <br>-->
	<!--GEOJSON_file_url = "{{ region_specs['geojson_url'] }}" <br>-->
	<!--GEOJSON_js_var   = "{{ region_specs['js_var'] }}" <br>-->
	
	{% set geojson_url      = region_specs['geojson_url'] %}
	{% set geojson_js_var   = region_specs['geojson_js_var'] %}
	{% set dflt_data_url    = region_specs['dflt_data_url'] %}
	{% set dflt_data_js_var = region_specs['dflt_data_js_var'] %}

	
	<!-- LEAFLET TEST DATAS
	<script>var nameVar = document.currentScript; </script>
	-->
	
	<!-- SAMPLES TEST -->
	<!--<script src="{{ url_for('static', filename='data_custom/Format_GEOJSON.json') }}" type="text/javascript">-->
	<!--	</script>-->

	
	<!-- JSON STATS // NEED TO BE MORE DYNAMIC - DEPEND ON VIEWS - Jinja + selection -->
	<!--<script src="{{ url_for('static', filename='data_custom/json_stats/countries_dict.js') }}" type="text/javascript"></script>-->
	<script src="{{ url_for('static', filename=dflt_data_url) }}" type="text/javascript"></script>
	
	<!-- GEOJSONS MARKERS // NEED TO BE DYNAMIC - DEPEND ON VIEWS - Jinja + selection  / ex: selection = "world"   --> 
	<script src="{{ url_for('static', filename='data_custom/geojson_labs/FablabsIO_fablabs.geojson') }}" type="text/javascript"></script> 
	<script src="{{ url_for('static', filename='data_custom/geojson_labs/Makery_fablabs.geojson') }}" type="text/javascript"></script>

	<!-- GEOJSONS BASEMAP // DYNAMIC - DEPEND ON VIEWS - Jinja (file_url) function of 'selection' / ex: selection = "world"  --> 	
	<script src="{{ url_for('static', filename = geojson_url) }}" type="text/javascript"></script>
	
	
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/regions/World/all_countries.geojson') }}" type="text/javascript"></script>-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/us-states.js') }}" type="text/javascript"></script>-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/regions/ESP/ESP_admin_level_4.geojson') }}" type="text/javascript"></script>-->
	
	
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/AUS_MAs_2016.geojson') }}" type="text/javascript"></script>-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/AUT_MAs_2016.geojson') }}" type="text/javascript"></script>-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/BEL_MAs_2016.geojson') }}" type="text/javascript"></script>-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/CAN_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/CHE_MAs_2016.geojson') }}" type="text/javascript"></script>-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/CHL_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/COL_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/CZE_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/DEU_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/DNK_MAs_2016.geojson') }}" type="text/javascript"></script>-->
	
	<!-- ESP_MAs_2016.geojson -->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/ESP_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/EST_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/FIN_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	
	<!-- FRA_MAs_2016.geojson -->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/FRA_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/GBR_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/GRC_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/HUN_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/IRL_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/ITA_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/JPN_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/KOR_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/LUX_FUAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/MEX_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/NLD_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/NOR_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/POL_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/PRT_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/SVK_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/SVN_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/SWE_MAs_2016.geojson') }}" type="text/javascript"></script>	-->
	<!--<script src="{{ url_for('static', filename='data_custom/geojson_basemaps/metropolitan_areas_OECD/USA_MAs_2016.geojson') }}" type="text/javascript"></script>-->
	
</div>


	
<div class="content" style="padding-bottom: 30px" >
    
    {% include 'modules/tools/mod_choose_place_demo.html' %}
    {% include 'modules/tools/mod_choose_indicator_demo.html' %}
    
</div>
	

<div class="content map" style="padding-bottom: 30px">
	
	<!-- DIV MAP -->
	<div 	id="map"
		style="width: 100%; height: {{ row['height'] }}">
	</div>
	
	<!-- LEAFLET / D3 SCRIPT -->
	<script>

		//// READ GEOJSON WITH D3 ////////////////// FAIL !!!
		//var d3_geojson = d3.json(M_fablabs, function (error, json) {
		//									if (error) 	console.log(error);
		//									console.log(json)
		//									}
		//						 )
		
		// FIND GEOBOX/CENTER/ZOOM settings from setViews.js
		var regionSelected = "{{ regionSelected }}";
		var userProfile    = "{{ user_profile }}"  ;
		
		
		
		
		// CREATE EMPTY LAYER
		//var empty_layer    = new L.layerGroup();

		// CREATE BASEMAPS LAYER
		var countries_layer = new L.layerGroup();
		var met_areas_layer = new L.layerGroup();

		// CREATE STATS LAYER
		var stats_layer    = new L.layerGroup();
		
		// CREATE FABLABS LAYER
		var fablabs_layer   = new L.layerGroup();
		
		
		// BASEMAP
		var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery <a href="http://mapbox.com">Mapbox</a>';
		var mbUrl  = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';
		
		var grayscale  = L.tileLayer(mbUrl, {id: 'mapbox.light'  , attribution: mbAttr});
		var streets    = L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr});

		


		function setMapView(placeName){
			//console.log("setMapView/placeName : ", placeName);
			var placeDict = setGeoViews[placeName]; //setGeoViews loaded as external .js file
			//console.log("setMapView/placeDict", placeDict);
			return placeDict; 
		};
		var region_settings = setMapView(regionSelected);
		var set_center_view = region_settings["center"];
		var set_zoom_view   = region_settings["zoom"];
		
		console.log("results setMapView() : ", regionSelected, region_settings)
		
		
		// SET MAP VIEW /////////////// NEED TO BE DYNAMIC - respond to view
		var map = L.map('map', {
			//center : [20, 0], 	// set_center_view
			center : set_center_view,
			//zoom   : 2,			// set_zoom_view
			zoom   : set_zoom_view,
			layers : [grayscale, fablabs_layer]
		});
		map.options.maxZoom = 10;
		map.options.minZoom = 2;

		
		
		/// INTERACTIONS 
		// control that shows state info on hover
		var info = L.control();

		info.onAdd = function (map) {
			this._div = L.DomUtil.create('div', 'info');
			this.update();
			return this._div;
		};

		info.update = function (props) {
			this._div.innerHTML = '<h4>Legend</h4>' +
			'<b><small>src:' + 'FablabsIO' +'</small><br>'+       //////////////////////////////// static datas
			(props ?
				'<b>' + props.addedDatas.countryName + '</b><br />'
				+ (props.addedDatas.population/1000000) + ' M pers.'
			: 'Hover over a state');
		};

		info.addTo(map);
		

		/////////////////////////////////////////
		// FUNCTION - ADD POPUP TO MARKERS
		function onEachMarker(feature, layer) {
			var props = feature.properties ;
			var popupContent = "<p></p>";
			if (props && props.name) {
				popupContent += '<h5>' + props.name + '</h5> ( ' +  props.lab_type + ' )' + '<hr>'+
								'<p style="margin-left: 15px"><em>city</em> : ' + props.city + ' ( ' + props.country_code + ' )' +
								'<br><em>address</em> : ' + props.address_1
								+ '</p>'
								;
			}
			layer.bindPopup(popupContent);
		}
		
		
		
		// STYLES ///////////////////////////////////////////////////////////////////////////////////////
		
		// get color depending on a choosen d.value /////////// REDO IN MORE GENERAL WAY ////////////////////////
		// cf http://hslpicker.com
		function getColor(d) {
			return d > 100*1000000  ? '#800026' :
			       d > 50*1000000   ? '#BD0026' :
			       d > 20*1000000   ? '#E31A1C' :
			       d > 10*1000000   ? '#FC4E2A' :
			       d > 5*1000000    ? '#FD8D3C' :
			       d > 2*1000000    ? '#FEB24C' :
			       d > 1*1000000    ? '#FED976' :
			                  '#FFEDA0';
		}
		
		
		function regionStyle(feature) {
			//console.log(feature); 
			var props = feature.properties;
			var fillColor ;
			if (feature.id !="-99" && feature.properties.addedDatas != undefined ) {
				fillColor = getColor(parseInt(props.addedDatas.population));
			}
			else { fillColor = "#00e0e0"  };
			return {
				weight     : 2,
				opacity    : 1,
				color      : 'white',
				dashArray  : '3',
				fillOpacity: 0.7,
				fillColor  : fillColor,
				//fillColor  : getColor(value),
				//fillColor  : '#00e0e0'
			};
		};
		
		
		// HIGHLIGHTS ON BASEMAPS // manage/hack z-index
		function highlightFeature(e) {
			
			var currentLayer = e.target;
			
			currentLayer.setStyle({
				weight      : 3,
				color       : '#727',
				dashArray   : '',
				fillOpacity : 0.7
			});
			
			if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
				currentLayer.bringToFront();
				for(var i=0; i<markerObjects.length; i++){
					markerObjects[i].bringToFront(); //bring markers over all
				}
				for(var i=0; i<markerObjects.length; i++){
					markerObjects[i].bringToFront(); //bring markers over all
				}
			};

			info.update(currentLayer.feature.properties);
		};
		
		function resetHighlight(e) {
			for (var i = 0; i<basemapObjects.length; i++) {
				var layer = basemapObjects[i];
				layer.resetStyle(e.target);
				info.update();
			}
		};

		function zoomToFeature(e) {
			map.fitBounds(e.target.getBounds());
		};

		function onEachBasemap(feature, layer) {
			layer.on({
			        mouseover: highlightFeature,
				mouseout : resetHighlight,
				click    : zoomToFeature
			});
		};
		
		
		/////////////////////////////////////////////////////////////////////////////////////////
		
		// LOAD BASEMAPS
		basemapObjects = [] ;
		function addBasemap (geojson, layer_, bottom) {
			
			var layer = L.geoJson(geojson, {
				style: regionStyle,
				onEachFeature: onEachBasemap
			})
			.addTo(map)
			.addTo(layer_, bottom);
			
			basemapObjects.push(layer);
			
		};
		
		
		// LOAD MARKER OBJECTS (fablabs) ///// MISSING DYNAMIC STYLES ////////////////////////
		markerObjects = [] ;
		function addPoints (json, layer_) {
			var layer = L.geoJson ( json	, {
				style: function (feature) {
					return feature.properties && feature.properties.style;
				},
				onEachFeature: onEachMarker,
				pointToLayer: function (feature, latlng) {
					return L.circleMarker(latlng, {
						radius   	: 5,
						fillColor	: "hsla(353, 80%, 52%, 1)",
						color    	: "#fff",
						weight   	: 3,
						opacity  	: 1,
						fillOpacity	: 0.8
					});
				}
			})
			.addTo(map)
			.addTo(layer_);
			markerObjects.push(layer);	
		};

		
		/////////////////////////////////////////////////////////////////////////////////////////
		
		// PLACE LEGEND - GRADIENTS
		var legend = L.control({position: 'bottomright'});
		legend.onAdd = function (map) {
			var div = L.DomUtil.create('div', 'info legend'), //div created with info lengend classes
				grades = [0, 1, 2, 5, 10, 20, 50, 100],
				labels = [],
				from, to;
			for (var i = 0; i < grades.length; i++) {
				from = grades[i];
				to   = grades[i + 1];
				labels.push(
					'<i style="background:' + getColor(from*1000000 + 1) + '"></i> ' +
					from + (to ? '&ndash;' + to : '+'));
			}
			div.innerHTML = labels.join('<br>');
			return div;
		};
		legend.addTo(map);
		
		
		
		// VARIABLES LEGEND GEOJSON COLLECTION MIN/MAX /// STILL TO PUT IN USE
		var basemapMax = 0;
		var basemapMin = 0;
		function getCollMinMax(featuresList, varName) {
			for (var i = 0; i<featuresList.length; i++) {
				var feature  = featuresList[i];
				var number   = feature[varName] ;
				if (number > basemapMax ) {
					basemapMax = number;
				}
				if (number < basemapMin) {
					basemapMin = number ;
				}
			}
		}
		
		// LOAD DATAS INTO GEOJSON 
		function addDatasToGeojson(geojson, datas_dict){
			var new_geojson = {"type":"FeatureCollection","features":[ ] } ;
			for (var i=0;i<geojson.features.length; i++){
				var feature                   = geojson.features[i];
				var datas_toAdd               = datas_dict[feature.id];
				feature.properties.addedDatas = datas_toAdd;
				new_geojson.features.push(feature);
			}
			//console.log(new_geojson.features[0]);
			return new_geojson;
		};
		
		
		// GEOJSONs TO UPDATE /////// NEED TO BE DYNAMIC /////////////////////////////////////////
		var all_countries_updated = addDatasToGeojson({{ geojson_js_var }}, {{ dflt_data_js_var }});

		
		
		// SERVE REGIONS ///////////////////////////////////////////////////////////////////////////////////
		
		// dynamically serving js_var names
		addBasemap({{ geojson_js_var }}, countries_layer, true)
		
		// ALL COUNTRIES SERVED -- all_countries_updated , all_countries
		//addBasemap(all_countries_updated, countries_layer, true);
		//addBasemap(ESP_admin_level_4, countries_layer, true);
		//addBasemap(FRA_admin_level_4, countries_layer, true);
		//addBasemap(PRT_admin_level_4, countries_layer, true);
		//addBasemap(ITA_admin_level_4, countries_layer, true);
		//
		//addBasemap(DEU_admin_level_4, countries_layer, true);
		//addBasemap(DNK_admin_level_4, countries_layer, true);
		//addBasemap(NLD_admin_level_4, countries_layer, true);
		
		// CHOOSE REGION AREAS TO SERVE -- insert as Jinja call here (DRY) //////////////////////////////

		
		// CHOOSE METROPOLITAN AREAS TO SERVE -- insert as Jinja call here (DRY) //////////////////////////////
		//addBasemap(AUS_MAs_2016, met_areas_layer, false);
		//addBasemap(AUT_MAs_2016, met_areas_layer, false);
		//addBasemap(BEL_MAs_2016, met_areas_layer, false);
		//addBasemap(CAN_MAs_2016, met_areas_layer, false);
		//addBasemap(CHE_MAs_2016, met_areas_layer, false);
		//addBasemap(CHL_MAs_2016, met_areas_layer, false);
		//addBasemap(COL_MAs_2016, met_areas_layer, false);
		//addBasemap(CZE_MAs_2016, met_areas_layer, false);
		//addBasemap(DEU_MAs_2016, met_areas_layer, false);
		//addBasemap(DNK_MAs_2016, met_areas_layer, false);
		
		//addBasemap(ESP_MAs_2016, met_areas_layer, false);
		//addBasemap(EST_MAs_2016, met_areas_layer, false);
		//addBasemap(FIN_MAs_2016, met_areas_layer, false);
		
		//addBasemap(FRA_MAs_2016, met_areas_layer, false);
		//addBasemap(GBR_MAs_2016, met_areas_layer, false);
		//addBasemap(GRC_MAs_2016, met_areas_layer, false);
		//addBasemap(HUN_MAs_2016, met_areas_layer, false);
		//addBasemap(IRL_MAs_2016, met_areas_layer, false);
		//addBasemap(ITA_MAs_2016, met_areas_layer, false);
		//addBasemap(JPN_MAs_2016, met_areas_layer, false);
		//addBasemap(KOR_MAs_2016, met_areas_layer, false);
		//addBasemap(LUX_FUAs_2016, met_areas_layer, false);
		//addBasemap(MEX_MAs_2016, met_areas_layer, false);
		//addBasemap(NLD_MAs_2016, met_areas_layer, false);
		//addBasemap(NOR_MAs_2016, met_areas_layer, false);
		//addBasemap(POL_MAs_2016, met_areas_layer, false);
		//addBasemap(PRT_MAs_2016, met_areas_layer, false);
		//addBasemap(SVK_MAs_2016, met_areas_layer, false);
		//addBasemap(SVN_MAs_2016, met_areas_layer, false);
		//addBasemap(SWE_MAs_2016, met_areas_layer, false);
		//addBasemap(USA_MAs_2016, met_areas_layer, false);
		
		
		// SERVE LABS //////////////////////////////////////////////////
		//addPoints(Makery_fablabs, fablabs_layer);
		addPoints(FablabsIO_fablabs, fablabs_layer);		
		
		
		
		// CREATE CONTROLS
		var baseLayers = {
			"Grayscale": grayscale,
			"Streets"  : streets
		};
		
		var overlays = {
			//"Empty layer" : empty_layer,
			"Fablabs"       : fablabs_layer,
			//"Metrop. areas" : met_areas_layer,
			"Countries"     : countries_layer
		};
		
		var controls = L.control.layers(baseLayers, overlays, {collapsed:false}).addTo(map);
		
		
		
		
		////////////////////////////////////////////////////////////////////////////////////////////////
		// ARCHIVE /  INVALID SCRIPTS
		
		//var checks = document.querySelectorAll('[type = "checkbox"]'), i;
		//function check() {
		//	for (i = 0; i < checks.length; ++i) {
		//		checks[i].disabled = false;
		//check();
		
		
		////FAILED CLUSTERS
		//var geoJsonData = {
		//	"type": "FeatureCollection", 
		//	"features": [
		//		{ "type": "Feature", "id":"1", "properties": { "address": "2"   }, "geometry": { "type": "Point", "coordinates": [175.2209316333,-37.8210922667 ] } },
		//		{ "type": "Feature", "id":"2", "properties": { "address": "151" }, "geometry": { "type": "Point", "coordinates": [175.2238417833,-37.80975435   ] } },
		//		{ "type": "Feature", "id":"3", "properties": { "address": "21"  }, "geometry": { "type": "Point", "coordinates": [175.2169955667,-37.818193     ] } },
		//		{ "type": "Feature", "id":"4", "properties": { "address": "14"  }, "geometry": { "type": "Point", "coordinates": [175.2240856667,-37.8216963    ] } },
		//		{ "type": "Feature", "id":"5", "properties": { "address": "38B" }, "geometry": { "type": "Point", "coordinates": [175.2196982333,-37.8188702167 ] } },
		//		{ "type": "Feature", "id":"6", "properties": { "address": "38"  }, "geometry": { "type": "Point", "coordinates": [175.2209942   ,-37.8192782833 ] } }
		//	]
		//};
		//var tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
		//	maxZoom: 18,
		//	attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		//});
		//var map = L.map('map')
		//		.addLayer(tiles);
		//var markers = L.markerClusterGroup();
		//var geoJsonLayer = L.geoJson(geoJsonData, {
		//	onEachFeature: function (feature, layer) {
		//		layer.bindPopup(feature.properties.address);
		//	}
		//});
		//markers.addLayer(geoJsonLayer);
		//map.addLayer(markers);
		//map.fitBounds(markers.getBounds());
	
	
		//// VALID GEOJSON OBJECT :
		//var Makery_fablabs_ = {	"type":"FeatureCollection",
		//						"features":[
		//									{	"type":"Feature", ///// <------ NECESSARY FOR GEOJSON 
		//										"geometry":{"type":"Point",
		//													"coordinates":[2.16843,48.7118]},
		//										"properties":{	"id":"1",
		//														"name":"(Fab)Lab Digiscope",
		//														"website":"http:\/\/fablabdigiscope.wordpress.com",
		//														"twitter":"",
		//														"facebook":"",
		//														"type_lab":"fablab",
		//														"url_makery":"",
		//														"adress":"660 Rue Noetzlin, Gif-sur-Yvette, 91190",
		//														"country":"FR",
		//														"marker-color":"#f00","marker-size":"small"},
		//									},
		//										
		//								   ]
		//						};

	
	
	</script>
</div>
